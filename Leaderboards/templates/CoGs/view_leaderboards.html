{% extends "CoGs/base.html" %}
{% load staticfiles %}
{% block title %}Leaderboards{% endblock %}

{% block content %}
<table class='options'>
	<tr>
		<td class='options' valign='top'>
			<span style="font-size:125%; font-weight: bold;">Format</span>
		</td>
		<td class='options'>
			these <b>{{ leaderboard_count }}</b> leaderboards 
			
			<label id='lblSnaps'></label>
			in
			
			<select id="selCols" onchange='DrawTables("tblLB");' autofocus>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
			  <option>5</option>
			  <option>6</option>
			</select>
			<label>columns</label>
			
			, use player 
			
			<select id="selNames" onchange="refetchLeaderboards(event)">
			  <option value="nick">nickname</option>
			  <option value="full">full name</option>
			  <option  value="complete">full name (nickname)</option>
			</select>
			
			and link
			
			<select id="selLinks" onchange='DrawTables("tblLB");'>
			  <option value="none">nowhere</option>
			  <option value="CoGs">internally</option>
			  <option value="BGG">boardgamegeek.com</option>
			</select>
			.<br>			
			<input type="checkbox" id="chkHighlightChanges" onchange='toggle_highlights();'> 
			Highlight changes.
			<input type="checkbox" id="chkSessionDetails" onchange='DrawTables("tblLB");'> 
			Show session details.
		</td>
	</tr>
	<tr>
		<td class='options' valign='top'>
			<button type="button" id='btnFilter' onclick="get_new_view();">Filter</button> 
		</td>
		<td class='options'>			
			leaderboards as <i><a onclick="toggle_filters();">follows</a></i>:
		</td>
	</tr>
	<tr class='toggle' style="display:none;">
		<td class='options'/>
		<td class='options' style="line-height:200%; padding-top:0px">
			<label>Only games played by league: </label><select id='selLeague'></select><br>
			<label>Only games played by player: </label><select id='selPlayer'"></select><br>
			<label>Only this game: </label><select id='selGame'></select><br>
			<label>Only leaderboards that changed on or after: </label>
			<input class="DateTimeField" id="from_date_time" type="text" value={{ changed_since|safe }} onchange="copy_if_empty('#from_date_time','#compare_back_to_date_time')"><br>
			<label>Leaderboards as they were at (i.e. historic snapshot): </label>
			<input class="DateTimeField" id="as_at_date_time" type="text" value={{ as_at|safe }}><br>
			<label>Compare each leaderboard with</label>
			<input id="compare_with" size=3 type="text" value={{ compare_with|safe }}  onkeyup="this.value=this.value.replace(/[^\d]+/,'')">
			<label>prior leaderboards, or leaderboards back to</label>
			<input class="DateTimeField" id="compare_back_to_date_time" type="text" value={{ compare_back_to|safe }}>
			<label>and/or up until</label>			
			<input class="DateTimeField" id="compare_till_date_time" type="text" value={{ compare_till|safe }}>
		</td>
	</tr>
	<tr>
		<td class='options'>
			<button type="button" id='btnCopy' onclick="prepare_target();" data-clipboard-target="#tblLB_naked">Copy</button> 
		</td>
		<td class='options'>
			leaderboards to clipboard
		</td>
	</tr>
</table>

<table id='tblLB'>
</table>
{% endblock %}

{% block startscript %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="{% static 'CoGs/js/jquery.datetimepicker.full.min.js'%}"></script>
<script src="{% static 'CoGs/js/clipboard.min.js' %}"></script>

{# Include the javascript jQuery library and a datetimepicker that leaves the Django one for dead #}
<link rel="stylesheet" type="text/css" href="{% static 'CoGs/css/jquery.datetimepicker.css' %}"/ >

<script>
	// Nab the data from context
	var leagues = {{ leagues|safe }};
	var league = {{ league|safe }};
	var players = {{ players|safe }};
	var player = {{ player|safe }};
	var games = {{ games|safe }};
	var game = {{ game|safe }};
	
	// The big one! Leaderboards. This is a structure of lists within lists
	// Games, Snapshots and Players in that order. 
	//
	// see view_Leaderboards for specs and generation of what is delivered, but here is
	// the expectation:
	// A list of lists which have four values: Game PK, Game BGGid, Game name, Snapshots
	// Snapshots is a list of lists which have four values: Date time string, count of plays, count of sessions, Leaderboard
	// Leaderboard is a list of lists which have six values: Player PK, Player BGGid, Player name, Trueskill rating, Play count, Victory count
	//
	// So lists within lists within a list. This is what we're here to present.
	//
	// As a side note, the standard view has one snapshot, the current ratings, and leaderboards pr at some other specified time (as_at) 
	// Extra snapshots are expected when asked for (for comparisons with history and evolutionary examinations), one
	// extra snapshot per compare_with (a number specifying how many) or a variable number if compare_back_to is specified, 
	// up to and including the snapshot at compare_till or now if compare_till isn't specified.  
	
	var leaderboards = {{leaderboards|safe}};
	
	// Layout is driven by snapshots.
	// 
	// If we have one snapshot per game all is normal and we can just layout 
	//    one board per game using cols as requested.
	// If we have two snapshots per game max, then we're comparing two points in time
	//    and snaphots can be presented in pairs. We can sort of respect cols as requested 
	//    but each col has a pair of snapshots side by side for comparison so we'll ensure it's 
	//    even (round up) and halve it to get about the requested number of columns.    
	// If we have more than 2 snapshots per game we are looking at leaderboard timelines 
	//    or evolutions and so want one game per row, and one column per snapshot, so we
	//    can safely ignore cols, and use a table as wide as maxshots.   
	
	var maxshots = 0;
	var totalshots = 0;
	for (var g=0; g<leaderboards.length; g++) {
		snapshots = leaderboards[g][3].length;
		totalshots += snapshots;
		if (snapshots > maxshots) maxshots = snapshots;
	}	 
	
	/// We can't access template variables in the included static javascript so here is 
	// where we nab what we need for the Javascript and stow in javascript variables that
	// the code in the included .js file can see.  
	
	// Note the initial value of various controls on the view
	value_cols = {{ cols|safe }};
	value_names = {{ names|safe }};
	value_links = {{ links|safe }};
	value_highlight = {{highlight}};
	value_details = {{details}};
	value_date_format = "{{default_datetime_input_format}}";
	
	// Note the default values of same controls
	default_cols = {{default_cols}};
	default_names = "{{default_names}}";
	default_highlight = JSON.parse("{{default_highlight}}".toLowerCase());
	default_details = JSON.parse("{{default_details}}".toLowerCase());
	default_links = "{{default_links}}";
	
	// And some catch all values
	ALL_LEAGUES = {{ ALL_LEAGUES|safe }};
	ALL_PLAYERS = {{ ALL_PLAYERS|safe }};
	ALL_GAMES = {{ ALL_GAMES|safe }};
	
	// And some URLs
	url_leaderboards = "{% url 'leaderboards' %}";
	url_json_leaderboards = "{% url 'json_leaderboards' %}"
	
	url_view_Game = "{% url 'view' 'Game' '00' %}";		// 00 is replaced by PK in the JavaScript code
	url_view_Player = "{% url 'view' 'Player' '00' %}"; // 00 is replaced by PK in the JavaScript code		
	url_list_Sessions = "{% url 'list' 'Session'%}";		
</script>
{% endblock %}

{% block endscript %}
<script src="{% static 'CoGs/js/view_leaderboards.js' %}"></script>	
{% endblock %}


