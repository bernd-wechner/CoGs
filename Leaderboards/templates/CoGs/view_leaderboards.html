{% extends "CoGs/base.html" %}
{% load staticfiles %}
{% block title %}Leaderboards{% endblock %}

{% block content %}
{{ widget_media }}
<script>
	$.fn.select2.defaults.set( "theme", "bootstrap" );
</script>

{#   A pile of options for leaderboards that will try populate a structure in the backend - Leaderboards.views.leaderboard_options#}
{#   while enforcing some rules locally in the UI for convenience with JS. The rules can be summarised as follows:   #}

<table class=LeaderboardOptions>
	<tr>
		<td class='tight options'>
			<b>View:</b>
			<img id='reloading_icon' src='{% static "Reload.apng" %}' style='vertical-align: middle; visibility:hidden;' align='right'>
		</td>
		<td class='tight options'>			
			<input type="button" id="btnLeaderboards" value="Leaderboards" onclick="refetchLeaderboards(event);">
		</td>
	</tr>
	<tr>
		<td class='options'>
			in
		</td>
		<td class='options'>
			<select id="cols" onchange='DrawTables("tblLB");' autofocus>
			  <option>1</option>
			  <option>2</option>
			  <option>3</option>
			  <option>4</option>
			  <option>5</option>
			  <option>6</option>
			</select>
			<label>columns</label>,

			linking game and player names to
			
			<select id="links" onchange='DrawTables("tblLB");'>
				{% for v, l in leaderboard_options.LinkSelections.items %}
				  <option value="{{ v }}">{{ l }}</option>
				{% endfor %}			  
			</select>
		</td>
	</tr>
	
{#	ADVANCED OPTIONS #}
	
	<tr>
		<td class='options' valign='top'>
			<span style="margin-right: 4ch;"><b><a onclick="toggle_options();">Advanced options&#9660;</a></b></span>
		</td>
		<td class='options'>
			<input type="checkbox" id="chkHighlightPlayers" onchange='toggle_highlights("players", this);'> 		
			Highlight players.

			<input type="checkbox" id="chkHighlightChanges" onchange='toggle_highlights("changes", this);'> 		
			Highlight changes.

			<input type="checkbox" id="chkHighlightSelected" onchange='toggle_highlights("selected", this);'> 			
			Highlight selected players.
			<br>

			<input type="checkbox" id="chkSessionDetails" onchange='DrawTables("tblLB");'> 		
			Show session details.
			
			<input type="checkbox" id="chkSessionAnalysisPre" onchange='DrawTables("tblLB");'> 		
			Show TrueSkill Predictions.
			
			<input type="checkbox" id="chkSessionAnalysisPost" onchange='DrawTables("tblLB");'> 
			Show Post-Session TrueSkill Predictions.			
		</td>
	</tr>
	
{#	FORMATTING OPTIONS #}
	
	<tr class="toggle" style="visibility: collapse;">
		<th class='options indent' colspan=2>
			Formatting:
		</th>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight' style="line-height:2;">
			Using player 
			<select id="names">
				{% for v, l in leaderboard_options.NameSelections.items %}
				  <option value="{{ v }}">{{ l }}</option>
				{% endfor %}			  
			</select>
		</td>
	</tr>
	
{#	FILTERING OPTIONS #}
	
	<tr class="toggle" style="visibility: collapse;">
		<th class='options indent' colspan=2>
			Filtering:
		</th>
	</tr>

	{# LEAGUE FILTERS #}
			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<th class='options tight'> 
			Leagues:
		</th>			
	</tr>			

	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<label>Only leaderboards for these leagues: </label>{{ widget_leagues }}<br>				
		</td>			
	</tr>			

	{# GAME FILTERS #}
		
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<th class='options tight'> 
			Games:				
		</th>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<input type="radio" name="game_selection" value="selected"> 
			<label>Only leaderboards for these games: </label>{{ widget_games }}
		</td>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<input type="radio" name="game_selection" value="top_n">
			<label>Only leaderboards for the</label>
			<input type="number" id="num_games" min="0" class="Number" style="width: 5ch;" onchange="blank_zero(this);"> most popular games
		</td>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<input type="radio" name="game_selection" value="activity"> 
			<label>Only leaderboards that changed on or after: </label>
			<input class="DateTimeField" id="changed_since" type="text" onchange="copy_if_empty('#changed_since','#compare_back_to');">
		</td>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<input type="radio" name="game_selection" value="played_by"> 
			<label>Only leaderboards for games played by one or more of these players: </label>{{ widget_players }}
		</td>			
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<input type="radio" name="game_selection" value="session_impact">
			Only leaderboards for games played in the last session of 
			<input type="number" id="num_days" min="0" class="Number" style="width: 5ch" onchange="mirror('#num_days','#num_days_ev'); blank_zero(this);">
			<label>days duration</label>
		</td>			
	</tr>			
	
	
	{# PLAYER FILTERS #}
			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<th class='options tight'> 
			Players:
		</th>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			Show 
			<input type="number" id="num_players" min="0" class="Number" style="width: 5ch;" onchange="blank_zero(this);"> 
				<select id="num_players_context">
					{% for v, l in leaderboard_options.PlayerNumContextSelections.items %}
					  <option value="{{ v }}">{{ l }}</option>
					{% endfor %}
				</select> in each leaderboard.
		</td>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<label>Show players who have played the game at least </label> 
				<input type="number" id="min_plays" min="0" class="Number" style="width: 5ch;" onchange="blank_zero(this);">
				<label>times</label>
		</td>			
	</tr>			
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;"> 
			<label>Show players who have played a game since: </label> 
				<input class="DateTimeField" id="played_since" type="text">
		</td>			
	</tr>			

{#	PERSPECTIVE OPTIONS #}
	
	<tr class="toggle" style="visibility: collapse;">
		<th class='options indent' colspan=2>
			Perspective:
		</th>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight' style="line-height:2;">
			<label>Leaderboards as they were at: </label>
			<input class="DateTimeField" id="as_at" type="text" > <label>(i.e. historic snapshot)</label><br>
		</td>			
	</tr>	

{#	EVOLUTION OPTIONS #}

	<tr class="toggle" style="visibility: collapse;">
		<th class='options indent' colspan=2>
			Evolution:
		</th>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight'  style="line-height:2;">
			<label>Compare each leaderboard with</label>:
		</td>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;">
			<input type="radio" name="evolution_selection" value="none">
			<label>nothing</label>
		</td>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;">
			<input type="radio" name="evolution_selection" value="n_prior">
			<input type="number" id="compare_with" min="0" class="Number" style="width: 5ch" onchange="blank_zero(this);">
			<label>prior leaderboards</label>
		</td>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;">
			<input type="radio" name="evolution_selection" value="back_to">
			<label>leaderboards back to:</label> <input class="DateTimeField" id="compare_back_to" type="text">
		</td>
	</tr>	
	<tr class="toggle" style="visibility: collapse;">
		<td class='options tight'/>
		<td class='options tight indent' style="line-height:2;">
			<input type="radio" name="evolution_selection" value="session_impact">
			leaderboards back to, just before, the last game session 
			<input type="number" id="num_days_ev" min="0" class="Number" style="width: 5ch" onchange="mirror('#num_days_ev','#num_days'); blank_zero(this);">
			<label>days duration</label>
		</td>
	</tr>
				
{#	ADVANCED ACTIONS #}
	
	<tr class="toggle" style="visibility: collapse;">
		<td class='options indent'>
			<button type="button" id='btnCopy' onclick="prepare_target();" data-clipboard-target="#tblLB_naked">Copy</button> 
		</td>
		<td class='options'>
			leaderboards to clipboard
		</td>
	</tr>
	<tr class="toggle" style="visibility: collapse;">
		<td class='options indent'>
			<button type="button" id='btnShowURL' onclick="show_url();">Show</button> 
		</td>
		<td class='options'>
			URL
		</td>
	</tr>
</table>

{#	PAGE HEADER #}

<h3><label id='lblTotalCount'></label><label id='lblSnapCount' style='margin-left:1ch'></label></h3>

{# THE LEADERBOARDS! - Placeholder filled by Javascript rendered of the template or ajax provided data #}
		
<table id='tblLB'></table>

{% endblock %}

{% block startscript %}
<script>
	// Nab the options and their defaults from context
	var options = {{ options|safe }};
	var defaults = {{ defaults|safe }};

	// Nab the data from context
	var leagues = {{ leagues|safe }};
	var players = {{ players|safe }};
	var games = {{ games|safe }};
	
	// The big one! Leaderboards. This is a structure of lists within lists
	// Games, Snapshots and Players in that order. 
	//
	// see view_Leaderboards for specs and generation of what is delivered, but here is
	// the expectation:
	// A list of lists which have four values: Game PK, Game BGGid, Game name, Snapshots
	// Snapshots is a list of lists which have four values: Date time string, count of plays, count of sessions, Leaderboard
	// Leaderboard is a list of lists which have six values: Player PK, Player BGGid, Player name, Trueskill rating, Play count, Victory count
	//
	// So lists within lists within a list. This is what we're here to present.
	//
	// As a side note, the standard view has one snapshot, the current ratings, and leaderboards pr at some other specified time (as_at) 
	// Extra snapshots are expected when asked for (for comparisons with history and evolutionary examinations), one
	// extra snapshot per compare_with (a number specifying how many) or a variable number if compare_back_to is specified, 
	// up to and including the snapshot at as_at or now if as_at isn't specified.  
	
	var leaderboards = {{leaderboards|safe}};
	
	/// We can't access template variables in the included static javascript so here is 
	// where we nab what we need for the Javascript and stow in javascript variables that
	// the code in the included .js file can see.  
	
	// Note the initial value of various controls on the view
	value_date_format = "{{default_datetime_input_format}}";
		
	// And some URLs
	url_leaderboards = "{% url 'leaderboards' %}";
	url_json_leaderboards = "{% url 'json_leaderboards' %}"
	
	url_view_Game = "{% url 'view' 'Game' '00' %}";		// 00 is replaced by PK in the JavaScript code
	url_view_Player = "{% url 'view' 'Player' '00' %}"; // 00 is replaced by PK in the JavaScript code		
	url_view_Team = "{% url 'view' 'Team' '00' %}"; 	// 00 is replaced by PK in the JavaScript code		
	url_list_Sessions = "{% url 'list' 'Session'%}";
	
	// A URL for the Select2 widgets (initilising them is a little involved)
	url_selector = "{% url 'autocomplete_flexible' '__MODEL__' 'pk' 'in' %}"		
</script>
{% endblock %}

{% block endscript %}
<script src="{% static 'CoGs/js/view_leaderboards.js' %}"></script>	
{% endblock %}


