{% extends "CoGs/base.html" %}
{% load staticfiles %}
{% load filters %}
{% load tags %}
{% block title %}{{title}}{% endblock %}
{% block content %}
{% if user.is_authenticated %}
	<p><a href="/add/{{model_name}}">Add {{ model_name.title }}</a></p>
{% endif %}	   

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript">
	// Save the URL when we load for later use
	function saveURL() {
		URL = "{% url 'get_list_html' model=model_name %}";
	}
	window.onload = saveURL;
	
	var filters	= {{filters}};

	function toggle_filters() {
		current = $(".toggle")[0].style.visibility;
		if (current == "collapse") 
			$(".toggle").css('visibility', 'visible'); 
		else
			$(".toggle").css('visibility', 'collapse');		
	}
	
	function check_button(which_one) {
		$("#opt_elements_"+which_one).prop("checked", true);
	}
	
	function URLopts() {
		var opts = []
	
		// The basic formatting and layout options
		elements = $('input[type=radio][name=opt_elements]:checked').attr('value');
		complete = $('input[type=radio][name=opt_complete]:checked').attr('value');
		link = $('input[type=radio][name=opt_link]:checked').attr('value');
		menus = $('input[type=radio][name=opt_menus]:checked').attr('value');
		
		opts.push(elements);
		opts.push(complete);
		opts.push(link);
		opts.push(menus);
		
		// The filter if specified
		for (f in filters) opts.push(filters[f]);
		
		opts.push(filter_url_opts());
		opts.push(ordering_url_opts());
		
		url_opts = (opts.length > 0) ? "?" + opts.join("&") : ""
		
		// Add the global league filter to URL opts used in GET requests 
		$league_id = $("#id_league_view").val();
		url_opts += ($league_id == 0) ? "" : "&league=" + $league_id;

		return url_opts;
	}
	
	var REQUEST = new XMLHttpRequest();
	REQUEST.onreadystatechange = function () {
	    // Process the returned JSON
		if (this.readyState === 4 && this.status === 200){
			var response = JSON.parse(this.responseText);
			$("#data").html(response.HTML);
			URL = response.json_URL 
 			window.history.pushState("","", response.view_URL);
			$("#reloading_icon").css("visibility", "hidden");
			$("#opt_brief").prop('disabled', false);
			$("#opt_verbose").prop('disabled', false);
			$("#opt_rich").prop('disabled', false);
			$("#opt_detail").prop('disabled', false);
			$("#opt_specified").prop('disabled', false);
		}
	};
	
	function reload(event) {
		$("#reloading_icon").css("visibility", "visible");
		$("#opt_brief").prop('disabled', true);
		$("#opt_verbose").prop('disabled', true);
		$("#opt_rich").prop('disabled', true);
		$("#opt_detail").prop('disabled', true);
		$("#opt_specified").prop('disabled', true);
		var url = URL + URLopts();
		REQUEST.open("GET", url, true);
		REQUEST.send(null);		
	}
	

	// These functions need to be writen/tested/ and then made part of the widgets themselves.
	// They are here for now to write and test before moving into widgets

	// Filter widget code seems in order and tested bar:
	// TODO add add datetimepicker to these
	// TODO: Ignore options who have no value! Don't add them to fopts.
	// TODO: Hmmm, have to support relations, like ranks_player (which should in fact be performances_player anyhow).	
  	function CollectFilterField(index, value) {
  		var field = $(value);
  		console.log("CollectFilterField: " + field);
  		
  		var opt = field.prop('name');
  		
  		var val = null;
  		if (field.is("input"))
  			val = field.val();
  		else if (field.is("select"))
  			val = field.find(":selected").val();
  		
		fopts.push(opt + "=" + val);
  	}
	
 	function filter_url_opts() {
		fopts = [];
		var widgetid = "session_filtering_widget";
  		console.log("filter_url_opts: " + widgetid);
		$("#"+widgetid).find(":input[id^='filter_field']").each(CollectFilterField);
		return fopts.join("&");	
 	}
  	
	// Ordering widget code seems in order and tested. Need to move this into widget def.	 
  	function CollectOrderingField(index, value) {fields.push($(value).text());}
  	function CollectOrderingDir(index, value) {dirs.push($(value).text());}

	function get_ordering_dir(text) {
	  if (text == String.fromCharCode(9650)) return "";
	  else if (text == String.fromCharCode(9660)) return "-";
	  else if (text == String.fromCharCode(9644)) return null;
	  else return null;
	}

 	function ordering_url_opts() {
		var widgetid = "session_ordering_widget";  	
		fields = [];  dirs = [];
		$("#"+widgetid).find("span[id^='ordering_field']").each(CollectOrderingField);
		$("#"+widgetid).find("span[id^='ordering_dir']").each(CollectOrderingDir);
		
		var opts = [];
		for (i = 0; i < fields.length; i++) {
			pfx = get_ordering_dir(dirs[i]);
			if (pfx != null) { 
				opts.push(pfx+fields[i]);
			}
		}
		
		return "ordering=" + opts.join(",");
	}	
</script>     

<p>{{model_name_plural | title}}: {{ object_list | length }}</p>

{#{% if get_params %}#}
{#<p>{{get_params}}</p>#}
{#{% endif %}#}

<table id="ListViewOptions" class="tight">
	<tr>
		<td class='tight options'>
			<b>Quick Views:</b>
		</td>
		<td class='tight options'>
			<img id='reloading_icon' src='{% static "Reload.apng" %}' style='vertical-align: middle; visibility:hidden;'>
			<input type="button" id="opt_brief" value="Brief" onclick="check_button('brief'); reload(event);">
			<input type="button" id="opt_verbose" value="Verbose" onclick="check_button('verbose'); reload(event);">
			<input type="button" id="opt_rich" value="Rich" onclick="check_button('rich'); reload(event);">
			<input type="button" id="opt_detail" value="Detail" onclick="check_button('detail'); reload(event);">
			<span style="margin-left: 8ch;"><b>Advanced options <a onclick="toggle_filters();">&#9660;</a></b></span>
		</td>
	</tr>
	<tr id="opt_summary_formats" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<br/>
			<input type="button" id="opt_specified" value="Show:" onclick="reload(event);">
		</td>
		<td class='tight options'>
			<br/>
			<input type="radio" name="opt_elements" id="opt_elements_brief" value="brief" {{format.elements|checked:1}}>Brief
			<input type="radio" name="opt_elements" id="opt_elements_verbose" value="verbose" {{format.elements|checked:2}}>Verbose
			<input type="radio" name="opt_elements" id="opt_elements_rich" value="rich" {{format.elements|checked:3}}>Rich
			<input type="radio" name="opt_elements" id="opt_elements_detail" value="detail" {{format.elements|checked:4}}>Detail
		</td>
	</tr>
	<tr id="opt_menu_formats" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<b>In:</b>
		</td>
		<td class='tight options'>
			<input type="radio" name="opt_complete" id="opt_complete_as_table" value="as_table" {{format.complete|checked:1}}>a table
			<input type="radio" name="opt_complete" id="opt_complete_as_ul" value="as_ul" {{format.complete|checked:2}}>a bulleted list
			<input type="radio" name="opt_complete" id="opt_complete_as_p" value="as_p" {{format.complete|checked:3}}>paragaphs
			<input type="radio" name="opt_complete" id="opt_complete_as_br" value="as_br" {{format.complete|checked:4}}>a pargraph
		</td>
	</tr>		
	<tr id="opt_link_formats" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<b>links:</b>
		</td>
		<td class='tight options'>
			<input type="radio" name="opt_link" id="opt_link_none" value="no_links" {{format.link|checked:0}}>None
			<input type="radio" name="opt_link" id="opt_link_internal" value="internal_links" {{format.link|checked:1}}>CoGs
			<input type="radio" name="opt_link" id="opt_link_external" value="external_links" {{format.link|checked:2}}>BGG
		</td>
	</tr>		
	<tr id="opt_menu_formats" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<b>Menus:</b>
		</td>
		<td class='tight options'>
			<input type="radio" name="opt_menus" id="opt_menus_none" value="no_menus" {{format.menus|checked:0}}>None
			<input type="radio" name="opt_menus" id="opt_menus_text" value="text_menus" {{format.menus|checked:1}}>Text
			<input type="radio" name="opt_menus" id="opt_menus_buttons" value="button_menus" {{format.menus|checked:2}}>Buttons
		</td>
	</tr>		
	<tr id="opt_filters" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<b>Filter on:</b>
		</td>
		<td class='tight options'>
			{{ widget_filters }}		
		</td>
	</tr>
	<tr id="opt_ordering" class='tight options toggle' style="visibility:collapse;">
		<td class='tight options'>
			<b>Order by:</b>
		</td>
		<td class='tight options'>
			{{ widget_ordering }}		
		</td>
	</tr>	
</table>
<p/>

{% if txt_filters %}
	<p><b>{{model_name_plural|title}} for:</b> {{txt_filters}}</p>
{% endif %}

<div id="data">{{ view.as_html }}</div>

{% endblock %}