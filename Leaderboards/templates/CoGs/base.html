<!DOCTYPE html>
<html>
<head>
	{% load staticfiles %}
	<title>{% block title %}{% endblock %}</title>
	<link rel="stylesheet" type="text/css" href="{% static 'CoGs/css/default.css' %}" />
	<link rel="icon" href="{% static 'favicon.ico' %}">
	<meta name="robots" content="NONE,NOARCHIVE" />
	<meta charset="UTF-8" />

	{# Include the javascript jQuery library and a datetimepicker that leaves the Django one for dead #}
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css"/ >
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.css"/ >
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.js"></script>

	<script>
		//Attach the datetimepicker to all DateTimeFields. Assumes DateTimeField widgets have the class "DateTimeField"
		const datetime_format = "{{default_datetime_input_format}}";
	</script>
	
{#    Consider moving this the cloudflare cdn too, just need to check it's the samee library.#}
{#    See: https://cdnjs.com/libraries/clipboard.js#}
{#    And: https://clipboardjs.com/#}
{#	  I use it in the leaderboards view.#}
	<script src="{% static 'CoGs/js/clipboard.min.js' %}"></script>
	
	<script src="{% static 'CoGs/js/jstz.min.js' %}"></script>
	<script src="{% static 'CoGs/js/datetime_functions.js' %}"></script>

	<script>
		// Template provided variables that submit_info.js expects.
		const CSRF_field 	= '{% csrf_token %}';
		const POST_RECEIVER = "{% url 'post_client_info' %}";
		const SESSION_timezone = "{{ request.session.timezone }}";
		const SESSION_utcoffset = "{{ request.session.utcoffset }}";
		const SESSION_location = "{{ request.session.location }}";
		const DJANGO_timezone = "{{ active_timezone }}";
		const DJANGO_utcoffset = "{{ active_utcoffset }}";
	</script>
	<script src="{% static 'CoGs/js/submit_info.js' %}"></script>

	<script>
		function check_for_leagues() {
			if ("{{league_options|escapejs}}"=="") 
				document.getElementById("league_selector").style.display = 'none';
		}
		
		function league_changed(event) {
			// Django provides (and demands if the server implemts it) Cross Site Request Forgery (CSRF) protection 
			// Django proveds us with a csrf_token which it wants to see in a POST submission or it will reject it.
			// This how Django knows the POST came from this form here and not some other submitter. 
			// The token comes as a HTML hidden form element, and we're building out own POST submission so
			// need to extract the name and value and compose a URI (Uniform Resource Identifer).
			const CSRF_name = CSRF_field.match( /name="(.*?)"/ )[1];
			const CSRF_value = CSRF_field.match( /value="(.*?)"/ )[1];
			const CSRF_uri = CSRF_name + "="  + encodeURI(CSRF_value);

			const FILTER_RECEIVER = "{% url 'post_filter' %}";
			const POST_FILTER = new XMLHttpRequest();
		
			const new_league = event.target.value;
			const submission = CSRF_uri + "&league=" + encodeURI(new_league)

			POST_FILTER.open("POST", FILTER_RECEIVER, true);
			POST_FILTER.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			POST_FILTER.onreadystatechange = function () { location.reload(); }
			POST_FILTER.send(submission);			
		}
	</script>
	{% block startscript %}{% endblock %}	
</head>

<body class="body"  onload="check_for_leagues()">
	<!-- Container -->
	<div id="container">
	
	    <!-- Header -->
	    <div id="header">	    	
	        {% block branding %}
	        <div id="branding">
	        	<a href="{% static 'logo.png' %}"><img src="{% static 'logo.png' %}" align=left height=70></a>
				<h1 id="site-name"><a href="/">CoGs Leaderboard Space</a></h1>
	        </div>
	        {% endblock %}
	        
	        {% block menu %}
	        <div id="menu-line" style="display: flex;">
		        <div id="menu" style="float: left;">
					{% if user.is_authenticated %}	        
		        		[ <a href="/admin">Admin</a> ]
					{% endif %}
						        	
		        	[ <a href="{% url 'leaderboards' %}">Leaderboards</a> ]
		        	
		        	[ <a href="{% url 'list' 'League' %}">Leagues</a> |
		        	<a href="{% url 'list' 'Game' %}">Games</a> |
		        	<a href="{% url 'list' 'Player' %}">Players</a> |
		        	<a href="{% url 'list' 'Location' %}">Locations</a> |
		        	<a href="{% url 'list' 'Session' %}">Sessions</a>]
	
					{% if user.is_authenticated %}
			        	[<a href="{% url 'list' 'Team' %}">Teams</a> |
			        	 <a href="{% url 'list' 'Rank' %}">Ranks</a> |
			        	 <a href="{% url 'list' 'Performance' %}">Performances</a> |
			        	 <a href="{% url 'list' 'Rating' %}">Ratings</a> ]
					{% endif %}
		        </div>
{#		        TODO: This league selecter needs to be set:#}
{#		          1) When logging in, set it to the default league of the logged in user.#}
{#						- for this we need to give each logged in user a default league.#}
{#		          2) When viewing a session, set it to the league of the session that was loaded.#}
		        <div id="league_selector" style="margin: 0 auto;">League:
					<select name="league_view" class="ModelChoiceField" required="" id="id_league_view" onchange="league_changed(event)">
						{{league_options|safe}}
					</select>				
		        </div>
		        <div id="login" style="float: right; margin-right:50px;">
					{% if user.is_authenticated %}
			        	[ Logged in as: {{ user.player }} | <a href="{% url 'logout' %}?next={{request.path}}"">Logout</a> | 
					{% else %}
			        	[ <a href="{% url 'login' %}?next={{request.path}}">Login</a> |
					{% endif %}
						        
					<a href="{% url 'about' %}">About</a> ]
		        </div>
	        </div>
	        {% endblock %}
	
	        {% block usertools %}
		        {% if has_permission %}
		        <div id="user-tools">
		            {% block welcome-msg %}
		                Welcome,
		                <strong>{% firstof user.get_short_name user.get_username %}</strong>.
		            {% endblock %}
		            {% block userlinks %}
		                {% if site_url %}
		                    <a href="{{ site_url }}">View site</a> /
		                {% endif %}
		                {% if user.is_active and user.is_staff %}
		                    {% url 'django-admindocs-docroot' as docsroot %}
		                    {% if docsroot %}
		                        <a href="{{ docsroot }}">Documentation</a> /
		                    {% endif %}
		                {% endif %}
		                {% if user.has_usable_password %}
		                	<a href="{% url 'admin:password_change' %}">Change password</a> /
		                {% endif %}
		                <a href="{% url 'admin:logout' %}">Log out</a>
		            {% endblock %}
		        </div>
		        {% endif %}
	        {% endblock %}
	    </div>
	    <!-- END Header -->
	
	    {% block messages %}
	        {% if messages %}
	        <ul class="messagelist">
	        	{% for message in messages %}
	          		<li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message|capfirst }}</li>
	        	{% endfor %}
	        </ul>
	        {% endif %}
	    {% endblock messages %}
	
	    <!-- Content -->
	    <div id="content" class="content">
	        {% block content_title %}<h1><div id='title'>{% autoescape off %}{{ title }}{% endautoescape %}</div></h1>{% endblock %}
	        {% block content_subtitle %}<h2><div id='subtitle'>{% autoescape off %}{{ subtitle }}{% endautoescape %}<div></h2>{% endblock %}
	        {% block content %}{% endblock %}
	        {% block sidebar %}{% endblock %}
	        <br class="clear" />
	    </div>
	    <!-- END Content -->
	
	    {% block footer %}
	    
	    {% if debug %}
			{% include "CoGs/include/timezone_diag.html" %}
			{% include "CoGs/include/session_spy.html" %}
        {% endif %}
        
	    <div id="footer">{{footer}}</div>{% endblock %}
	</div>
	<!-- END Container -->
</body>

<script>			
	// Attach a datetimepicker to all DateTimeFields. 
	// Assumes DateTimeField widgets have the class "DateTimeField"
	$(function(){
		$(".DateTimeField").datetimepicker({
			"format": datetime_format,
			"step" : 15
		});
	});
</script>

{% block endscript %}{% endblock %}
</html>
